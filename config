ngx_addon_name=ngx_http_webp_module

# Check if JPEG XL support should be enabled
ngx_feature="JPEG XL support"
ngx_feature_name="NGX_HTTP_WEBP_JXL_ENABLED"
ngx_feature_run=no
ngx_feature_incs="#include <jxl/encode.h>"
ngx_feature_path=
ngx_feature_libs="-ljxl"
ngx_feature_test="JxlEncoderCreate(NULL);"

if [ "$HTTP_WEBP_JXL" != "NO" ]; then
    . auto/feature

    if [ $ngx_found = yes ]; then
        have=NGX_HTTP_WEBP_JXL_ENABLED . auto/have
    else
        echo "JPEG XL library not found. Disabling JPEG XL support."
        HTTP_WEBP_JXL=NO
    fi
else
    echo "JPEG XL support is explicitly disabled."
fi

if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP
    ngx_module_name=ngx_http_webp_module
    ngx_module_srcs="$ngx_addon_dir/ngx_http_webp_module.c $ngx_addon_dir/ngx_http_webp_cache.c $ngx_addon_dir/ngx_http_webp_conversion.c"
    ngx_module_libs="-lwebp -lavif -lpthread"

    if [ "$HTTP_WEBP_JXL" != "NO" ]; then
        ngx_module_libs="$ngx_module_libs -ljxl"
    fi

    . auto/module
else
    HTTP_MODULES="$HTTP_MODULES ngx_http_webp_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_webp_module.c $ngx_addon_dir/ngx_http_webp_cache.c $ngx_addon_dir/ngx_http_webp_conversion.c"
    CORE_LIBS="$CORE_LIBS -lwebp -lavif -lpthread"

    if [ "$HTTP_WEBP_JXL" != "NO" ]; then
        CORE_LIBS="$CORE_LIBS -ljxl"
    fi
fi

if [ "$HTTP_WEBP_JXL" = "NO" ]; then
    echo "JPEG XL support is disabled"
else
    echo "JPEG XL support is enabled"
fi

# Check for thread pool support
ngx_feature="Thread pool support"
ngx_feature_name="NGX_THREADS"
ngx_feature_run=no
ngx_feature_incs="#include <ngx_thread_pool.h>"
ngx_feature_path=
ngx_feature_libs=
ngx_feature_test="ngx_thread_pool_t pool;"

. auto/feature

if [ $ngx_found = no ]; then
    echo "Error: Thread pool support is required for this module."
    echo "Please compile NGINX with --with-threads option."
    exit 1
fi

have=NGX_THREADS . auto/have